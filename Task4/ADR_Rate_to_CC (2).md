# ADR: Передача ставок в кол-центр и партнёрский кол-центр

**Статус:** Proposed → Accepted (после утверждения)  
**Дата:** 2025-08-11  
**Автор:** Команда цифровой трансформации (банк «Стандарт»)  
**Связанное решение:** MVP цифровизации депозитов (FURPS+), архитектура RS/DS/ESB/SMS

---

## 1. Контекст и проблема

Проект MVP по открытию депозитов реализует показ и подачу заявок через сайт и интернет‑банк. Ставки управляются в XLS и загружаются в банковский **Rate Service (RS)** с хранением в БД/кеше.  
Бизнес запускает маркетинговую кампанию; ожидается всплеск обращений пожилых клиентов в кол‑центр. Требуется:
1) дать **внутреннему кол‑центру (CC)** актуальные ставки;  
2) наладить **передачу ставок партнёрскому кол‑центру (P‑CC)**, который работает во внешней системе и **может получать только файлы (CSV/XLS)**. Прямые API‑вызовы недоступны.

Ограничения: использовать существующий стек (MS SQL/Oracle, ESB, совместимые очереди), безопасность ПДн, 24/7, 99.9% для клиентских сценариев; АБС нагружать минимально (только по необходимости согласования условий).

---

## 2. Цели решения

- Обеспечить **оперативную и устойчивую публикацию ставок** для CC и P‑CC с минимальной ручной работой.  
- Свести к нулю риск устаревших ставок на линии кол‑центров.  
- Сохранить совместимость с текущим IT‑ландшафтом и политиками безопасности.

---

## 3. Область действия

Включает: Rate Service, модуль экспорта ставок, интеграцию с **CRM/CC**, процесс генерации и защищённой передачи файлов партнёру, мониторинг и аудит.  
Исключает: изменения в АБС сверх подтверждения условий депозита (без новых API).

---

## 4. Use Cases

| UC | Акторы | Описание | Триггер | Результат |
|----|--------|----------|---------|-----------|
| UC‑1 | Сотрудник CC | Просмотр актуальных ставок в CRM/CC | Открытие карточки звонка | Актуальные ставки доступны онлайн |
| UC‑2 | CRM/CC, RS | Автоматическое обновление ставок в CRM/CC | Изменение ставок или расписание | CC видит обновлённые ставки без ручных действий |
| UC‑3 | ESB, RS, P‑CC | Генерация файла ставок и передача партнёру | Расписание (каждые 15 мин) или событие | Файл доставлен партнёру, подтверждение доставки зафиксировано |
| UC‑4 | Сотр. P‑CC | Консультация клиента по ставкам | Входящий звонок | Используются последние полученные ставки |
| UC‑5 | Оператор BO | Ретрансляция обновления ставок | Импорт XLS → RS | Автоматическая дистрибуция в CC и файл для P‑CC |

---

## 5. Функциональные требования

1. **Экспорт ставок** из RS в **CSV/XLS** (конфигурируемые колонки/форматы).  
2. **Интеграция с CRM/CC**: загрузка ставок по внутреннему API/адаптеру ESB.  
3. **Генерация файла** для P‑CC в согласованном формате (CSV по умолчанию).  
4. **Передача файла партнёру** по **защищённому каналу** (SFTP/HTTPS upload; при отсутствии обратного API — выкладка в согласованное внешнее хранилище).  
5. **Планировщик**: периодичность (например, каждые 15 минут) + ручной запуск.  
6. **Логирование и аудит**: кто/когда/что выгрузил, куда доставлено, контроль версий.  
7. **Версионирование схемы файла** (v1, v2) и обратная совместимость.  
8. **Валидация данных** (диапазоны ставок, валюты, сроки, статусы продукта).  
9. **Опционально**: локализация денежных форматов и округления (RU).

---

## 6. Нефункциональные требования

- **Производительность**: экспорт ≤ 5 сек при ≤ 10k строк, загрузка в CRM ≤ 5 сек.  
- **Надёжность/Доступность**: 99.9% для цепочки публикации (исключая внешнюю систему партнёра). Ретраи, очереди и DLQ.  
- **Безопасность**: TLS/SFTP, контроль доступа (RBAC), шифрование «на диске» для staging, маскирование в логах.  
- **Сопровождаемость**: конфиг через централизованный конфиг‑сервис, наблюдаемость (метрики/логи/трейсы), feature flags.  
- **Аудит/Комплаенс**: протоколирование операций, неизменяемые логи (WORM/ретеншн).

---

## 7. Решение (Decision)

Выбрано **автоматизированное распределение ставок** из RS:  
- Для **внутреннего CC** — **онлайн‑обновление** через ESB/адаптер в CRM/CC (пуллинг или пуш по событию).  
- Для **P‑CC** — **периодическая генерация файла** (CSV) и **безопасная доставка** в их систему (SFTP/HTTPS).  
- Подтверждение доставки и мониторинг через единый дашборд.

**Почему:** соответствует ограничениям партнёра (только файлы), минимизирует ручные операции, масштабируется, прозрачно мониторится.

---

## 8. Архитектурные изменения (над предыдущим MVP)

- Добавлен **Rate Exporter** (модуль экспорта) в составе RS.  
- Добавлен **CC Adapter** (интеграция CRM/CC ← RS через ESB).  
- Добавлен **Partner File Publisher** (генерация/выкладка файлов).  
- **Scheduler**/оркестрация: периодические задания, ретраи, DLQ.  
- Метрики: свежесть ставок, успешность загрузок/доставок, латентность.

---

## 9. C4 Диаграммы

- **Context**: `C4_Context.drawio` — Клиенты, IB/WEB, RS, DS, ESB, CRM/CC, P‑CC, SMS, ABS.  
- **Component (выдержка по ставкам)**: `C4_Component.drawio` — RS, Rate Exporter, CC Adapter, Partner File Publisher, Scheduler, ESB, CRM Adapter.

> Диаграммы будут приложены в draw.io (см. артефакты шага 2).

---

## 10. Альтернативы и последствия

| Вариант | Плюсы | Минусы/Риски |
|---------|------|--------------|
| Партнёрский API к RS | Near real‑time, без файлов | Недоступно по условиям кейса |
| Ручная выгрузка сотрудником | Нулевые доработки | Ошибки, задержки, нет SLA/аудита |
| **Автовыгрузка + доставка файла (выбор)** | Автоматизация, SLA, аудит, масштабируемость | Требует разработки модулей экспорта/доставки |

**Торговые офферы/персональные ставки:** при необходимости — отдельный файл или раздел с ограниченным доступом и шифрованием.

---

## 11. Риски и меры снижения

- **Перегрузка CC**: обеспечить кратный масштаб фронтов CC и кэш в CRM для ставок.  
- **Просрочка доставки в P‑CC**: ретраи, DLQ, оповещения, ручной ре‑ран.  
- **Несоответствие форматов**: версионирование CSV, контрактные тесты.  
- **Утечка данных**: шифрование, VPN/SFTP, минимизация ПДн в файлах (ставки без PII).

---

## 12. Список крупных задач по системам

**Rate Service (RS):**
- Реализовать **Rate Exporter** (CSV/XLS), версионирование схемы, конфиг формата.
- Публичный эндпоинт/шина событий об обновлении ставок (для CC Adapter).

**ESB / Интеграционный слой:**
- Разработать **CC Adapter** (pull/push) для CRM/CC.
- Реализовать **Partner File Publisher**: генерация файла, доставка (SFTP/HTTPS), квитанции.
- Настроить **Scheduler**, ретраи, DLQ, мониторинг.

**CRM/CC (внутренняя система):**
- Приём и обновление ставок (API/таблица), кэширование, права доступа.

**Security/Infra/Monitoring:**
- Каналы шифрования, учётные данные, ротация секретов, аудит.
- Дашборды: свежесть, ошибки, время доставки.

---

## 13. Roadmap (план работ)

**0–2 мес (Фаза A, MVP‑1):**
- RS: Exporter v1 (CSV), базовая схема, ручной запуск + расписание.
- ESB: CC Adapter (pull), загрузка в CRM/CC.
- Мониторинг/логирование базовых метрик.

**2–4 мес (Фаза B, MVP‑2):**
- ESB: Partner File Publisher, защищённая доставка партнёру.
- Ретраи, DLQ, оповещения, дашборды.
- Контрактные тесты формата файла.

**4–6 мес (Фаза C, Hardening):**
- Оптимизация производительности, кеш в CRM/CC.
- Версионирование файлов (v2), локализация/форматы.
- DR‑тесты, нагрузочное тестирование.

**Горизонт 12 мес (Target):**
- Персональные ставки для CC.
- Возможный переход P‑CC на API (если появится возможность).
- Единый real‑time кэш ставок.

**Артефакт Roadmap:** `Roadmap_CC_Rates.drawio` (см. шаг 3).

---

## 14. Решение принято

- **Owner:** Архитектор решения / Лид интеграций  
- **Критерии готовности:** автоматическая публикация ставок в CC и P‑CC подтверждена метриками, SLA соблюдены, аудит включён.

